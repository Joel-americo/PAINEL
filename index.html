<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEILOG - Painel do Analista</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #111827; /* bg-gray-900 */
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .kpi-card-sm {
            background-color: rgba(31, 41, 55, 0.7);
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
        /* Custom pulse animations for alerts */
        @keyframes pulse-red { 50% { background-color: rgba(239, 68, 68, 0.15); } }
        .animate-pulse-red { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-yellow { 50% { background-color: rgba(245, 158, 11, 0.15); } }
        .animate-pulse-yellow { animation: pulse-yellow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        /* Estilo para o cursor no gráfico de performance */
        #performance-chart {
            cursor: pointer;
        }
    </style>
</head>
<body class="text-white font-sans">
    <div class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Cabeçalho -->
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">Painel do Analista</h1>
                <p class="text-gray-400 mt-1">Visão em tempo real do pátio - HEILOG</p>
            </div>
            <!-- Botão de controle de som -->
            <div>
                <button id="toggle-sound-btn" class="p-2 rounded-full hover:bg-gray-700" title="Ativar/Desativar Som">
                    <!-- O ícone será inserido pelo JS -->
                </button>
            </div>
        </header>

        <!-- Abas de Navegação -->
         <div class="mb-4">
            <div class="border-b border-gray-700">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-patio" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-blue-500 text-white">Pátio</button>
                    <button id="tab-historico" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-300">Histórico</button>
                    <button id="tab-ocorrencias" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-300">Ocorrências</button>
                    <button id="tab-performance" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-300">Performance</button>
                </nav>
            </div>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="main-content">
            <!-- KPIs e Gráfico Padrão (Visível nas abas Pátio/Histórico) -->
            <section id="kpi-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6" id="kpi-container"></div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col justify-center items-center">
                    <h3 class="text-lg font-semibold text-white mb-2">Composição do Pátio</h3>
                    <div id="pie-chart-container" class="relative w-full h-full min-h-52">
                        <canvas id="patio-pie-chart" class="max-h-52"></canvas>
                        <div id="pie-chart-no-data" class="absolute inset-0 flex items-center justify-center text-gray-400 hidden">
                            <span>Pátio vazio.</span>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Tabela Principal (Pátio, Histórico, Ocorrências) -->
            <main id="table-main-content" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <h2 id="table-title" class="text-2xl font-semibold">Pátio</h2>
                    <div id="filters-container" class="flex flex-wrap items-center gap-4">
                        <select id="filter-status" class="bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- Options populated by JS -->
                        </select>
                        <select id="filter-transportadora" class="bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="todas">Todas Transportadoras</option>
                        </select>
                        <input type="text" id="search-input" placeholder="Buscar por DT ou Motorista..." class="w-full sm:w-auto bg-gray-700 border border-gray-600 rounded-lg py-2 pl-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                        <button id="clear-history-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            Limpar Histórico
                        </button>
                        <button id="export-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Exportar
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead id="table-head"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </main>

            <!-- Conteúdo da Aba Performance (Inicia oculto) -->
            <div id="performance-content" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Coluna Esquerda -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 id="hora-hora-title" class="text-xl font-bold mb-4">Chegadas no Pátio (Hora a Hora)</h3>
                            <div id="hora-hora-table" class="max-h-80 overflow-y-auto"></div>
                        </div>
                         <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold mb-4">Fluxo Carregamento (Finalizados no Turno)</h3>
                            <div id="fluxo-carregamento-kpis" class="grid grid-cols-2 gap-4"></div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold mb-4">Fluxo para Entrar (Veículos no Pátio)</h3>
                            <div id="fluxo-entrar-kpis" class="grid grid-cols-2 gap-4"></div>
                        </div>
                    </div>
                    <!-- Coluna Direita -->
                    <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg">
                        <h3 id="performance-chart-title" class="text-xl font-bold mb-4">Chegadas no Pátio (Hora a Hora)</h3>
                        <div id="performance-chart-container" class="relative h-96">
                             <canvas id="performance-chart"></canvas>
                             <div id="performance-chart-no-data" class="absolute inset-0 flex items-center justify-center text-gray-400 hidden">
                                <span>Sem chegadas no turno para exibir.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center modal-backdrop hidden"></div>
    <div id="occurrence-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center modal-backdrop hidden"></div>
    <div id="resolution-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center modal-backdrop hidden"></div>
    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center modal-backdrop hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-4">Confirmar Ação</h3>
            <p id="confirm-modal-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Firebase e Lógica da Aplicação -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, addDoc, serverTimestamp, setLogLevel, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB9B2-xYb6gr92cQDbajriQiinfQurrOwI",
            authDomain: "heilog-logistica.firebaseapp.com",
            projectId: "heilog-logistica",
            storageBucket: "heilog-logistica.appspot.com",
            messagingSenderId: "790492229739",
            appId: "1:790492229739:web:de49887de535a839e8412e"
        };
        const appId = "heilog-logistica";

        // --- Estado da Aplicação ---
        let db;
        let patioData = [], historicoData = [], ocorrenciasData = [];
        let activeTab = 'patio';
        let selectedOperacao = null;
        let patioChart = null;
        let performanceChart = null;
        let notifiedVehicles = new Set();
        let newlyAdded = new Set();
        let audioContext;
        let timerIntervalId = null;
        let confirmCallback = null;
        let soundEnabled = true; 
        let currentShiftPerformanceData = {};
        const ICONS = {
            SOUND_ON: `<svg class="w-6 h-6 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" /></svg>`,
            SOUND_OFF: `<svg class="w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l-2.25 2.25M19.5 12l2.25-2.25M12.75 15l3-3m0 0-3-3m3 3H6.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`
        };


        // --- Lógica de Negócio ---
        const getPriorityStatusLogic = (op) => {
            let statusText = "Normal", className = "bg-gray-500/20 text-gray-300", reasons = [], isAlert = false;
            if (op.status === 'Finalizado') {
                return { statusText: op.status, className: "bg-green-500/20 text-green-300", isAlert: false };
            }
            if (op.status === 'Cancelado') {
                 return { statusText: op.status, className: "bg-red-500/20 text-red-300", isAlert: false };
            }

            const { agenda, xtAdicional, data } = op || {};
            if (!agenda) return { statusText, className, isAlert };
            const getScheduledDateTime = (dateStr, timeStr) => {
                if (!dateStr || !dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) dateStr = new Date().toLocaleDateString('pt-BR');
                if (!timeStr || !timeStr.match(/^\d{1,2}:\d{2}(:\d{2})?$/)) return null;
                const timeParts = timeStr.split(':');
                const [day, month, year] = dateStr.split('/');
                const [hours, minutes] = timeParts;
                const seconds = timeParts.length > 2 ? timeParts[2] : 0;
                return new Date(year, parseInt(month, 10) - 1, day, hours, minutes, seconds);
            };
            const now = new Date();
            const scheduledDateTime = getScheduledDateTime(data, agenda);
            let isPriority = false, isOtif = false, isTop18 = false, isAntecipacao = false, isGradeQueimada = false, isAtrasado = false;
            isTop18 = (xtAdicional || '').toUpperCase().includes('TOP');
            if (scheduledDateTime) {
                const diffHours = (now.getTime() - scheduledDateTime.getTime()) / 3600000;
                const today = new Date(now); today.setHours(0, 0, 0, 0);
                const scheduledDay = new Date(scheduledDateTime); scheduledDay.setHours(0, 0, 0, 0);
                if (today < scheduledDay) isAntecipacao = true;
                else if (today.getTime() === scheduledDay.getTime()) {
                    if (diffHours >= -2 && diffHours <= 1) isOtif = true;
                    else if (diffHours > 1) isAtrasado = true;
                } else if (today > scheduledDay) isGradeQueimada = true;
            }
            isPriority = isOtif || isTop18 || isAntecipacao;
            if (isGradeQueimada) { statusText = "Grade Queimada"; className = "bg-yellow-500/30 text-yellow-300 border-yellow-500/50"; isAlert = true; } 
            else if (isAtrasado) { statusText = "Atrasado"; className = "bg-amber-600/30 text-amber-400 border-amber-500/50"; } 
            else if (isPriority) {
                if (isTop18) reasons.push("TOP 18"); if (isOtif) reasons.push("OTIF"); if (isAntecipacao) reasons.push("Antecipação");
                statusText = `Prioridade (${reasons.join('/')})`; className = "bg-red-500/30 text-red-300 border-red-500/50"; isAlert = true;
            }
            return { statusText, className, isAlert };
        };

        const getElapsedTime = (registrationTime) => {
            if (!registrationTime) return '00:00:00';
            const diff = Date.now() - registrationTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        const playAlertSound = () => {
            if (!soundEnabled || !audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5);
        };
        
        const showBrowserNotification = (title, body, tag) => {
             if (!("Notification" in window)) {
                console.log("Este navegador não suporta notificações de desktop");
                return;
            }
            if (Notification.permission === "granted") {
                new Notification(title, { body, tag, icon: './favicon.ico' });
            } else if (Notification.permission !== "denied") {
                 Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(title, { body, tag, icon: './favicon.ico' });
                    }
                });
            }
        }

        // --- Funções de Renderização ---
        const render = () => {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const transportadoraFilter = document.getElementById('filter-transportadora').value;

            let dataSet;
            if (activeTab === 'patio') dataSet = patioData;
            else if (activeTab === 'historico') dataSet = historicoData;
            else dataSet = ocorrenciasData;
            
            const filteredData = dataSet.filter(op => {
                if (activeTab === 'ocorrencias') {
                    return (op.dt?.toLowerCase() || '').includes(searchTerm) || (op.description?.toLowerCase() || '').includes(searchTerm);
                }

                const searchMatch = (op.dt?.toLowerCase() || '').includes(searchTerm) || (op.motorista?.toLowerCase() || '').includes(searchTerm);
                const transportadoraMatch = transportadoraFilter === 'todas' || op.transportadora === transportadoraFilter;
                
                let statusMatch = statusFilter === 'todos';
                if (!statusMatch) {
                    const { statusText } = getPriorityStatusLogic(op);
                    statusMatch = statusText.includes(statusFilter);
                }
                
                return searchMatch && statusMatch && transportadoraMatch;
            });
            
            if (activeTab === 'performance') {
                renderPerformanceDashboard();
            } else {
                renderTable(filteredData);
                renderKPIs();
                renderChart();
                updateTransportadoraFilter();
            }
        };

        const renderTable = (data) => {
            const tableBody = document.getElementById('table-body');
            const tableHead = document.getElementById('table-head');
            
            const headers = {
                patio: 'DT,Status,Agenda,Tempo no Pátio,Motorista,Transportadora,Ações',
                historico: 'DT,Status,Agenda,Motorista,Transportadora,Finalizado Em,Ações',
                ocorrencias: 'Data,DT,Canal,Prioridade,Problema Identificado,Descrição,Status,Ações'
            };
            tableHead.innerHTML = `<tr class="border-b border-gray-700">${headers[activeTab].split(',').map(h => `<th class="p-4 text-sm font-semibold text-gray-400">${h}</th>`).join('')}</tr>`;
            
            if(data.length === 0){
                const colspan = headers[activeTab].split(',').length;
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-8 text-gray-400">Nenhuma informação encontrada.</td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map(op => {
                const { statusText, className } = getPriorityStatusLogic(op);
                const isNew = newlyAdded.has(op.id);
                const pulseClass = isNew ? (className.includes('red') ? 'animate-pulse-red' : 'animate-pulse-yellow') : '';
                const statusBadge = `<span class="px-3 py-1 text-xs font-medium rounded-full ${className}">${statusText}</span>`;
                
                let opDataForActions = op;
                if (activeTab === 'ocorrencias') {
                    opDataForActions = patioData.find(p => p.id === op.operacaoId) || historicoData.find(h => h.id === op.operacaoId) || {};
                }

                const telefone = opDataForActions.telefone;
                const motorista = opDataForActions.motorista || 'Motorista';
                const dt = opDataForActions.dt || op.dt || '';

                const whatsappMsgIcon = `<svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413 0 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.586-1.456l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.447-4.435-9.884-9.888-9.884-5.448 0-9.886 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.289.173-1.413z"/></svg>`;
                const whatsappCallIcon = `<svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.95 21c-1.23 0-2.43-.2-3.58-.58a18.06 18.06 0 0 1-7.2-4.48 18.06 18.06 0 0 1-4.48-7.2c-.38-1.15-.58-2.35-.58-3.58C4.11 3.99 4.99 3 6.16 3h2.87c.66 0 1.25.41 1.47.95A13.19 13.19 0 0 0 11 6.1c.14.61-.17 1.25-.65 1.72l-1.5 1.5c1.16 2.11 2.89 3.84 5 5l1.5-1.5c.47-.48 1.11-.79 1.72-.65a13.19 13.19 0 0 0 2.15.45c.54.22 1 .81.95 1.47v2.87c0 1.17-.99 2.05-2.16 2.05zM6.16 4a1.11 1.11 0 0 0-1.05.7c-.2.63-.33 1.3-.35 2.04.01.68.1 1.35.26 2l.33.98.01.03.01.02c1.9 5.2 6.78 10.1 11.96 11.96l.02.01.03.01.98.33c.65.17 1.32.25 2 .26.75-.02 1.41-.15 2.04-.35a1.11 1.11 0 0 0 .7-1.05v-2.87c0-.28-.15-.54-.39-.68a12.2 12.2 0 0 1-2.3-.5c-.32-.1-.65 0-.88.23l-2.08 2.08a.5.5 0 0 1-.7-.31 16.5 16.5 0 0 1-6.7-6.7.5.5 0 0 1-.31-.7l2.08-2.08c.23-.23.33-.56.23-.88a12.2 12.2 0 0 1-.5-2.3c-.14-.24-.4-.39-.68-.39H6.16z"/></svg>`;
                const callIcon = `<svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>`;
                
                const safeTelefone = telefone || '';
                const whatsappMsgButton = `<button data-action="whatsapp-msg" data-telefone="${safeTelefone}" data-motorista="${motorista}" data-dt="${dt}" title="WhatsApp Mensagem" class="${telefone ? 'text-green-400 hover:text-green-300' : 'text-gray-600 cursor-not-allowed'}" ${!telefone ? 'disabled' : ''}>${whatsappMsgIcon}</button>`;
                const whatsappCallButton = `<button data-action="whatsapp-call" data-telefone="${safeTelefone}" title="WhatsApp Chamada" class="${telefone ? 'text-green-400 hover:text-green-300' : 'text-gray-600 cursor-not-allowed'}" ${!telefone ? 'disabled' : ''}>${whatsappCallIcon}</button>`;
                const callButton = `<button data-action="call" data-telefone="${safeTelefone}" title="Ligar (Celular)" class="${telefone ? 'text-blue-400 hover:text-blue-300' : 'text-gray-600 cursor-not-allowed'}" ${!telefone ? 'disabled' : ''}>${callIcon}</button>`;

                let specificActions = '';
                if (activeTab === 'patio') {
                    specificActions = `
                        <button data-action="details" data-id="${op.id}" title="Ver Detalhes"><svg class="w-5 h-5 text-sky-400 hover:text-sky-300 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg></button>
                        <button data-action="occurrence" data-id="${op.id}" title="Adicionar Ocorrência"><svg class="w-5 h-5 text-amber-400 hover:text-amber-300 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.3 14.8C20.1 14 21 12.6 21 11c0-4.4-3.6-8-8-8s-8 3.6-8 8c0 1.6.9 3 1.7 3.8"/><path d="M12 21c-1.7 0-3-1.3-3-3h6c0 1.7-1.3 3-3 3Z"/><path d="M12 6v6"/><path d="M9 9h6"/></svg></button>
                        <button data-action="finish" data-id="${op.id}" title="Finalizar Operação"><svg class="w-5 h-5 text-green-400 hover:text-green-300 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></button>
                        <button data-action="cancel" data-id="${op.id}" title="Cancelar DT" class="text-red-500 hover:text-red-400"><svg class="w-5 h-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    `;
                } else if (activeTab === 'ocorrencias') {
                    specificActions = `<button data-action="edit-occurrence" data-id="${op.id}" title="Ver/Editar Resolução" class="text-blue-400 hover:text-blue-300"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button>`;
                }

                const actionButtonsHTML = `<td class="p-4 flex items-center gap-4">${whatsappMsgButton}${whatsappCallButton}${callButton}${specificActions}</td>`;
                
                let rowCells = '';
                if (activeTab === 'ocorrencias') {
                    rowCells = `
                        <td class="p-4 text-sm">${op.timestamp ? new Date(op.timestamp.seconds * 1000).toLocaleString('pt-BR') : 'N/A'}</td>
                        <td class="p-4 font-mono text-sm">${op.dt}</td>
                        <td class="p-4 text-sm">${op.canal || 'N/A'}</td>
                        <td class="p-4 text-sm">${op.prioridade || 'N/A'}</td>
                        <td class="p-4 text-sm">${op.type}</td>
                        <td class="p-4 text-sm">${op.description}</td>
                        <td class="p-4 text-sm">${op.statusOcorrencia || 'Em andamento'}</td>
                        ${actionButtonsHTML}
                    `;
                } else {
                     rowCells = `
                        <td class="p-4 font-mono text-sm">${op.dt || ''}</td>
                        <td class="p-4">${statusBadge}</td>
                        <td class="p-4">${op.agenda || 'N/A'}</td>
                        ${activeTab === 'patio' ? `<td class="p-4 font-mono text-sm timer-cell" data-registration-time="${op.registrationTime}">${getElapsedTime(op.registrationTime)}</td>` : ''}
                        ${activeTab === 'historico' ? `<td class="p-4 text-sm">${op.finishedTime ? new Date(op.finishedTime).toLocaleString('pt-BR') : 'N/A'}</td>` : ''}
                        <td class="p-4">${op.motorista}</td>
                        <td class="p-4">${op.transportadora}</td>
                        ${actionButtonsHTML}
                      `;
                }

                return `<tr class="border-b border-gray-700 hover:bg-gray-700/50 ${pulseClass}">${rowCells}</tr>`;
            }).join('');
        };
        
        const renderKPIs = () => {
            const kpiContainer = document.getElementById('kpi-container');
            const kpis = {
                veiculosPatio: patioData.length,
                atrasados: patioData.filter(op => getPriorityStatusLogic(op).statusText === 'Atrasado').length,
                prioridades: patioData.filter(op => getPriorityStatusLogic(op).statusText.includes('Prioridade')).length,
                finalizadasHoje: historicoData.filter(op => new Date(op.finishedTime || 0).toDateString() === new Date().toDateString()).length,
            };
            kpiContainer.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center space-x-4">
                    <div class="p-3 rounded-full bg-blue-500/20"><svg class="w-6 h-6 text-blue-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"/><path d="M14 9h4l4 4v4h-8v-4c0-1.1.9-2 2-2z"/><circle cx="7.5" cy="18.5" r="2.5"/><circle cx="17.5" cy="18.5" r="2.5"/></svg></div>
                    <div><p class="text-sm text-gray-400">Veículos no Pátio</p><p class="text-2xl font-bold">${kpis.veiculosPatio}</p></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center space-x-4">
                    <div class="p-3 rounded-full bg-amber-500/20"><svg class="w-6 h-6 text-amber-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
                    <div><p class="text-sm text-gray-400">Veículos Atrasados</p><p class="text-2xl font-bold">${kpis.atrasados}</p></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center space-x-4">
                    <div class="p-3 rounded-full bg-red-500/20"><svg class="w-6 h-6 text-red-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
                    <div><p class="text-sm text-gray-400">Prioridades</p><p class="text-2xl font-bold">${kpis.prioridades}</p></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center space-x-4">
                    <div class="p-3 rounded-full bg-green-500/20"><svg class="w-6 h-6 text-green-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
                    <div><p class="text-sm text-gray-400">Finalizadas Hoje</p><p class="text-2xl font-bold">${kpis.finalizadasHoje}</p></div>
                </div>
            `;
        };

        const renderChart = () => {
            const noDataMsg = document.getElementById('pie-chart-no-data');
            const canvas = document.getElementById('patio-pie-chart');

            if (patioData.length === 0) {
                noDataMsg.classList.remove('hidden');
                canvas.style.display = 'none';
                if (patioChart) {
                    patioChart.destroy();
                    patioChart = null;
                }
                return;
            }

            noDataMsg.classList.add('hidden');
            canvas.style.display = 'block';

            const counts = patioData.reduce((acc, op) => {
                const status = getPriorityStatusLogic(op).statusText.split('(')[0].trim();
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            const chartLabels = Object.keys(counts);
            const chartValues = Object.values(counts);
            const COLORS = { 'Prioridade': '#ef4444', 'Grade Queimada': '#f59e0b', 'Atrasado': '#d97706', 'Normal': '#3b82f6' };
            const backgroundColors = chartLabels.map(label => COLORS[label] || '#8884d8');
            
            const ctx = canvas.getContext('2d');
            if (patioChart) patioChart.destroy();
            patioChart = new Chart(ctx, {
                type: 'pie',
                data: { labels: chartLabels, datasets: [{ data: chartValues, backgroundColor: backgroundColors, borderColor: '#1f2937', borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#d1d5db', boxWidth: 12, padding: 15 } } }
                }
            });
        };

        const renderPerformanceDashboard = () => {
            const now = new Date();
            const hour = now.getHours();
            let currentShift, shiftStartHour, shiftEndHour;

            if (hour >= 6 && hour < 14) { 
                currentShift = 1; shiftStartHour = 6; shiftEndHour = 14;
            } else if (hour >= 14 && hour < 22) { 
                currentShift = 2; shiftStartHour = 14; shiftEndHour = 22;
            } else { 
                currentShift = 3; shiftStartHour = 22; shiftEndHour = 6;
            }

            const shiftStartDate = new Date();
            shiftStartDate.setHours(shiftStartHour, 0, 0, 0);

            if (currentShift === 3 && hour < shiftStartHour) {
                shiftStartDate.setDate(shiftStartDate.getDate() - 1);
            }

            const shiftEndDate = new Date(shiftStartDate);
            if (shiftEndHour < shiftStartHour) {
                shiftEndDate.setDate(shiftEndDate.getDate() + 1);
            }
            shiftEndDate.setHours(shiftEndHour, 0, 0, 0);

            const shiftHistoricoData = historicoData.filter(op => {
                const finishedTime = op.finishedTime;
                return finishedTime && finishedTime >= shiftStartDate.getTime() && finishedTime < shiftEndDate.getTime();
            });
            
            const fluxoCarregamento = shiftHistoricoData.reduce((acc, op) => {
                if (op.transportadora === 'Ritmo') acc.ritmo++;
                else acc.clientes++;
                return acc;
            }, { clientes: 0, ritmo: 0 });

            const fluxoEntrar = patioData.reduce((acc, op) => {
                if (op.transportadora === 'Ritmo') acc.ritmo++;
                else acc.clientes++;
                return acc;
            }, { clientes: 0, ritmo: 0 });

            const allOps = [...patioData, ...historicoData];
            const horaHoraData = {};
            const shiftHours = [];
            let h = shiftStartHour;
            while(h !== shiftEndHour){
                shiftHours.push(h);
                horaHoraData[h] = { hora: h, clientes: 0, ritmo: 0, vehicles: [] };
                h = (h + 1) % 24;
            }

            allOps.forEach(op => {
                if (op.registrationTime) {
                    const registrationDate = new Date(op.registrationTime);
                    const opHour = registrationDate.getHours();
                    if (horaHoraData.hasOwnProperty(opHour)) {
                        const registrationTimestamp = registrationDate.getTime();
                        if (registrationTimestamp >= shiftStartDate.getTime() && registrationTimestamp < shiftEndDate.getTime()) {
                            if (op.transportadora === 'Ritmo') horaHoraData[opHour].ritmo++;
                            else horaHoraData[opHour].clientes++;
                            horaHoraData[opHour].vehicles.push(op);
                        }
                    }
                }
            });

            currentShiftPerformanceData = { ...horaHoraData };
            
            // Títulos voltaram para "Hora a Hora"
            document.getElementById('hora-hora-title').textContent = `Chegadas no Pátio (Hora a Hora) - ${currentShift}º Turno`;
            document.getElementById('performance-chart-title').textContent = `Chegadas no Pátio (Hora a Hora) - ${currentShift}º Turno`;

            document.getElementById('fluxo-carregamento-kpis').innerHTML = `
                <div class="kpi-card-sm p-4 rounded-lg text-center"><p class="text-sm text-gray-400">CLIENTES</p><p class="text-3xl font-bold">${fluxoCarregamento.clientes}</p></div>
                <div class="kpi-card-sm p-4 rounded-lg text-center"><p class="text-sm text-gray-400">RITMO</p><p class="text-3xl font-bold">${fluxoCarregamento.ritmo}</p></div>
            `;
            document.getElementById('fluxo-entrar-kpis').innerHTML = `
                <div class="kpi-card-sm p-4 rounded-lg text-center"><p class="text-sm text-gray-400">CLIENTES</p><p class="text-3xl font-bold">${fluxoEntrar.clientes}</p></div>
                <div class="kpi-card-sm p-4 rounded-lg text-center"><p class="text-sm text-gray-400">RITMO</p><p class="text-3xl font-bold">${fluxoEntrar.ritmo}</p></div>
            `;

            const sortedHoras = Object.values(horaHoraData).sort((a,b) => shiftHours.indexOf(a.hora) - shiftHours.indexOf(b.hora));
            
            // Lógica de acumulação removida, voltando à contagem por hora.
            document.getElementById('hora-hora-table').innerHTML = `
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-700"><tr>
                        <th class="p-2">Hora</th><th class="p-2 text-center">Clientes</th><th class="p-2 text-center">Ritmo</th>
                    </tr></thead>
                    <tbody>${sortedHoras.length > 0 ? sortedHoras.map(d => `
                        <tr class="border-b border-gray-700">
                            <td class="p-2 font-bold">${String(d.hora).padStart(2,'0')}:00</td>
                            <td class="p-2 text-center text-lg font-semibold text-cyan-300">${d.clientes}</td>
                            <td class="p-2 text-center text-lg font-semibold text-lime-300">${d.ritmo}</td>
                        </tr>`).join('') : `<tr><td colspan="3" class="p-4 text-center text-gray-400">Nenhuma chegada no turno.</td></tr>`}
                    </tbody>
                </table>`;
            
            // Gráfico usa os dados por hora, não acumulados.
            const chartLabels = sortedHoras.map(d => `${String(d.hora).padStart(2,'0')}:00`);
            const chartClientesData = sortedHoras.map(d => d.clientes);
            const chartRitmoData = sortedHoras.map(d => d.ritmo);

            const perfCanvas = document.getElementById('performance-chart');
            const perfNoData = document.getElementById('performance-chart-no-data');

            const hasData = chartClientesData.some(v => v > 0) || chartRitmoData.some(r => r > 0);
            if (!hasData) {
                perfNoData.classList.remove('hidden');
                perfCanvas.style.display = 'none';
                if (performanceChart) {
                    performanceChart.destroy();
                    performanceChart = null;
                }
                return;
            }

            perfNoData.classList.add('hidden');
            perfCanvas.style.display = 'block';

            const perfCtx = perfCanvas.getContext('2d');
            if (performanceChart) performanceChart.destroy();
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: { 
                    labels: chartLabels, 
                    datasets: [
                        {
                            label: 'Clientes', data: chartClientesData, fill: true,
                            borderColor: 'rgb(56, 189, 248)', backgroundColor: 'rgba(56, 189, 248, 0.2)', tension: 0.3,
                            pointBackgroundColor: 'rgb(56, 189, 248)', pointRadius: 4
                        },
                        {
                            label: 'Ritmo', data: chartRitmoData, fill: true,
                            borderColor: 'rgb(163, 230, 53)', backgroundColor: 'rgba(163, 230, 53, 0.2)', tension: 0.3,
                            pointBackgroundColor: 'rgb(163, 230, 53)', pointRadius: 4
                        }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, ticks: { color: '#d1d5db', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#d1d5db' }, grid: { color: 'rgba(255,255,255,0.1)' } } }, 
                    plugins: { legend: { labels: { color: '#d1d5db' } } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const clickedLabel = chartLabels[dataIndex];
                            const hour = parseInt(clickedLabel.split(':')[0], 10);
                            const hourData = currentShiftPerformanceData[hour];
                            if (hourData && hourData.vehicles.length > 0) {
                                showHourlyDetailsModal(clickedLabel, hourData.vehicles);
                            }
                        }
                    }
                }
            });
        };


        const updateStatusFilterOptions = (tab) => {
            const filterStatusSelect = document.getElementById('filter-status');
            let optionsHTML = '';
            if (tab === 'historico') {
                optionsHTML = `
                    <option value="todos">Todos Status</option>
                    <option value="Finalizado">Finalizado</option>
                    <option value="Cancelado">Cancelado</option>
                `;
            } else { 
                optionsHTML = `
                    <option value="todos">Todos Status</option>
                    <option value="Prioridade">Prioridade</option>
                    <option value="Grade Queimada">Grade Queimada</option>
                    <option value="Atrasado">Atrasado</option>
                    <option value="Normal">Normal</option>
                `;
            }
            filterStatusSelect.innerHTML = optionsHTML;
        };

        const updateTransportadoraFilter = () => {
            const select = document.getElementById('filter-transportadora');
            const allOps = [...patioData, ...historicoData];
            const transportadoras = [...new Set(allOps.map(op => op.transportadora).filter(Boolean))];
            
            const currentSelectedValue = select.value;

            while (select.options.length > 1) {
                select.remove(1);
            }

            transportadoras.sort().forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                select.appendChild(option);
            });
            
            select.value = currentSelectedValue;
        };
        
        // --- Interação e Eventos ---
        window.addEventListener('load', () => {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('error');
            
            Notification.requestPermission();
            const soundBtn = document.getElementById('toggle-sound-btn');
            const savedSoundPref = localStorage.getItem('heilogSoundEnabled');
            if (savedSoundPref !== null) {
                soundEnabled = JSON.parse(savedSoundPref);
            }
            soundBtn.innerHTML = soundEnabled ? ICONS.SOUND_ON : ICONS.SOUND_OFF;
            soundBtn.addEventListener('click', () => {
                soundEnabled = !soundEnabled;
                soundBtn.innerHTML = soundEnabled ? ICONS.SOUND_ON : ICONS.SOUND_OFF;
                localStorage.setItem('heilogSoundEnabled', JSON.stringify(soundEnabled));
            });

            document.getElementById('details-modal').innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl relative"><h3 id="details-modal-title" class="text-xl font-bold text-white mb-4"></h3><button onclick="window.closeDetailsModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg></button><div id="details-modal-content" class="text-gray-300 space-y-2 max-h-[60vh] overflow-y-auto"></div><div id="details-modal-actions" class="mt-4 pt-4 border-t border-gray-700 flex items-center gap-4"></div></div>`;
            document.getElementById('occurrence-modal').innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg relative"><h3 id="occurrence-modal-title" class="text-xl font-bold text-white mb-4"></h3><button onclick="window.closeOccurrenceModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg></button><form id="occurrence-form" class="space-y-4"><div><label for="occurrenceType" class="block text-sm font-medium text-gray-300">Problema Identificado</label><select id="occurrenceType" name="type" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 sm:text-sm"><option>Mecânico</option><option>Operacional</option><option>Trânsito</option><option>Climático</option><option>Fiscal</option><option>Outro</option></select></div><div><label for="occurrenceDescription" class="block text-sm font-medium text-gray-300">Descrição</label><textarea id="occurrenceDescription" name="description" rows="3" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 sm:text-sm"></textarea></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Ocorrência</button></form></div>`;
            document.getElementById('resolution-modal').innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg relative"><h3 id="resolution-modal-title" class="text-xl font-bold text-white mb-4"></h3><button onclick="window.closeResolutionModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg></button><div id="resolution-modal-content" class="text-gray-300 space-y-2 mb-4"></div><form id="resolution-form" class="space-y-4"><hr class="border-gray-600"><div><label for="resolutionText" class="block text-sm font-medium text-gray-300 mt-4">Ação de Resolução</label><textarea id="resolutionText" name="resolution" rows="4" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 sm:text-sm"></textarea></div><div><label for="resolutionStatus" class="block text-sm font-medium text-gray-300">Atualizar Status</label><select id="resolutionStatus" name="status" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 sm:text-sm"><option value="Em andamento">Em andamento</option><option value="Concluído">Concluído</option><option value="Cancelado">Cancelado</option></select></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Resolução</button></form></div>`;
            
            updateStatusFilterOptions('patio'); 

            document.getElementById('search-input').addEventListener('input', render);
            document.getElementById('filter-status').addEventListener('change', render);
            document.getElementById('filter-transportadora').addEventListener('change', render);
            document.getElementById('export-csv-btn').addEventListener('click', exportToCsv);
            document.getElementById('clear-history-btn').addEventListener('click', () => {
                showConfirmModal('Tem certeza que deseja limpar todo o histórico? Esta ação é irreversível.', clearHistory);
            });
            document.getElementById('occurrence-form').addEventListener('submit', handleAddOccurrence);
            document.getElementById('resolution-form').addEventListener('submit', handleUpdateResolution);
            document.getElementById('table-body').addEventListener('click', handleTableClick);
            document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
                document.getElementById('confirm-modal').classList.add('hidden');
                confirmCallback = null;
            });
             document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                document.getElementById('confirm-modal').classList.add('hidden');
                confirmCallback = null;
            });

            const allTabs = [document.getElementById('tab-patio'), document.getElementById('tab-historico'), document.getElementById('tab-ocorrencias'), document.getElementById('tab-performance')];
            allTabs.forEach(tab => tab.addEventListener('click', () => {
                allTabs.forEach(t => { t.classList.remove('text-white', 'border-blue-500'); t.classList.add('text-gray-400', 'border-transparent'); });
                tab.classList.add('text-white', 'border-blue-500'); tab.classList.remove('text-gray-400', 'border-transparent');
                activeTab = tab.id.replace('tab-', ''); 
                
                const showPerformance = activeTab === 'performance';
                const showHistorico = activeTab === 'historico';
                document.getElementById('kpi-section').style.display = showPerformance ? 'none' : 'grid';
                document.getElementById('table-main-content').style.display = showPerformance ? 'none' : 'block';
                document.getElementById('performance-content').style.display = showPerformance ? 'block' : 'none';
                document.getElementById('clear-history-btn').style.display = showHistorico ? 'flex' : 'none';
                
                updateStatusFilterOptions(activeTab);
                
                document.getElementById('table-title').textContent = activeTab.charAt(0).toUpperCase() + activeTab.slice(1);

                render();
            }));

            onAuthStateChanged(auth, user => {
                if (user) {
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/patio`), snap => {
                        const newPatioData = snap.docs.map(d => ({...d.data(), id: d.id}));
                        newlyAdded.clear();
                        newPatioData.forEach(op => {
                            const { statusText, isAlert } = getPriorityStatusLogic(op);
                            const isExisting = patioData.some(oldOp => oldOp.id === op.id);
                            if (isAlert && !notifiedVehicles.has(op.id)) {
                                playAlertSound();
                                showBrowserNotification(`Alerta de Prioridade: ${op.dt}`, `Veículo entrou em status de ${statusText}`, `alert-${op.id}`);
                                notifiedVehicles.add(op.id);
                            }
                            if (!isExisting) {
                                newlyAdded.add(op.id);
                                setTimeout(() => { newlyAdded.delete(op.id); render(); }, 5000);
                            }
                        });
                        patioData = newPatioData;
                        render();
                    });
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/historico`), snap => { 
                        historicoData = snap.docs.map(d => ({...d.data(), id: d.id})); 
                        render(); 
                    });
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/ocorrencias`), snap => { 
                        ocorrenciasData = snap.docs.map(d => ({...d.data(), id: d.id})).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); 
                        render(); 
                    });
                }
            });

            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Authentication failed:", error);
                }
            })();

            if (timerIntervalId) clearInterval(timerIntervalId);
            timerIntervalId = setInterval(() => {
                if (activeTab === 'patio') {
                    document.querySelectorAll('.timer-cell').forEach(cell => {
                        const time = cell.getAttribute('data-registration-time');
                        if (time) cell.textContent = getElapsedTime(parseInt(time));
                    });
                }
                // Garante que o painel de performance atualize a cada minuto para refletir a hora atual.
                if(activeTab === 'performance') {
                    renderPerformanceDashboard();
                }
            }, 60000); // Roda a cada minuto
        });
        
        function handleTableClick(e) {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            if (!action) return;

            if (action.startsWith('whatsapp') || action === 'call') {
                const phone = button.dataset.telefone;
                if (!phone) return;
                if (action === 'whatsapp-msg') {
                    const name = button.dataset.motorista || 'Motorista';
                    const dt = button.dataset.dt || '';
                    openWhatsApp(phone, name, dt);
                } else if (action === 'whatsapp-call') {
                    makeWhatsAppCall(phone);
                } else if (action === 'call') {
                    makeCall(phone);
                }
                return;
            }

            const id = button.dataset.id;
            if (!id) return;
            selectedOperacao = patioData.find(op => op.id === id) || historicoData.find(op => op.id === id) || ocorrenciasData.find(op => op.id === id);
            if (!selectedOperacao) {
               const occ = ocorrenciasData.find(o => o.id === id);
               if (occ) {
                    selectedOperacao = patioData.find(p => p.id === occ.operacaoId) || historicoData.find(h => h.id === occ.operacaoId) || occ;
               }
            }
             if (!selectedOperacao) return;


            switch(action) {
                case 'details': showDetailsModal(); break;
                case 'occurrence': showOccurrenceModal(); break;
                case 'finish': showConfirmModal('Tem certeza que deseja finalizar esta operação?', finalizarOperacao); break;
                case 'cancel': showConfirmModal(`Tem certeza que deseja cancelar a DT ${selectedOperacao.dt}? Esta ação não pode ser desfeita.`, cancelarOperacao); break;
                case 'edit-occurrence': showResolutionModal(); break;
            }
        }

        function showConfirmModal(text, callback) {
            document.getElementById('confirm-modal-text').textContent = text;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }
        
        window.showDetailsModal = () => {
             if (!selectedOperacao) return;
            document.getElementById('details-modal-title').textContent = `Detalhes da DT: ${selectedOperacao.dt}`;
            const modalContent = document.getElementById('details-modal-content');
            const modalActions = document.getElementById('details-modal-actions');
            modalContent.innerHTML = `<p><strong>Motorista:</strong> ${selectedOperacao.motorista || 'N/A'}</p><p><strong>CPF:</strong> ${selectedOperacao.cpf || 'N/A'}</p><p><strong>Telefone:</strong> ${selectedOperacao.telefone || 'N/A'}</p><p><strong>Placa:</strong> ${selectedOperacao.placa || 'N/A'}</p><p><strong>Transportadora:</strong> ${selectedOperacao.transportadora || 'N/A'}</p><p><strong>Destino:</strong> ${selectedOperacao.destino || 'N/A'}</p><p><strong>Agenda:</strong> ${selectedOperacao.agenda || 'N/A'}</p><p><strong>Chegada no Pátio:</strong> ${selectedOperacao.registrationTime ? new Date(selectedOperacao.registrationTime).toLocaleString('pt-BR') : 'N/A'}</p>`;
            if (selectedOperacao.telefone) {
                modalActions.innerHTML = `<button onclick="window.openWhatsApp('${selectedOperacao.telefone}', '${selectedOperacao.motorista}', '${selectedOperacao.dt}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">Msg WhatsApp</button><button onclick="window.makeWhatsAppCall('${selectedOperacao.telefone}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">Ligar WhatsApp</button><button onclick="window.makeCall('${selectedOperacao.telefone}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">Ligar (Celular)</button>`;
            } else { modalActions.innerHTML = ''; }
            document.getElementById('details-modal').classList.remove('hidden');
        };
        window.closeDetailsModal = () => document.getElementById('details-modal').classList.add('hidden');
        
        window.showHourlyDetailsModal = (hour, vehicles) => {
            document.getElementById('details-modal-title').textContent = `Veículos que chegaram na hora das ${hour}`;
            const modalContent = document.getElementById('details-modal-content');
            const modalActions = document.getElementById('details-modal-actions');
            
            const vehiclesHtml = vehicles.map(v => `
                <div class="p-2 border-b border-gray-700">
                    <strong>DT:</strong> ${v.dt} | 
                    <strong>Motorista:</strong> ${v.motorista} | 
                    <strong>Transportadora:</strong> ${v.transportadora} |
                    <strong>Chegada:</strong> ${new Date(v.registrationTime).toLocaleTimeString('pt-BR')}
                </div>
            `).join('');

            modalContent.innerHTML = vehiclesHtml.length > 0 ? vehiclesHtml : '<p>Nenhum veículo chegou nesta hora específica.</p>';
            modalActions.innerHTML = ''; 
            document.getElementById('details-modal').classList.remove('hidden');
        };
        
        window.showOccurrenceModal = () => {
            if(!selectedOperacao) return;
            document.getElementById('occurrence-modal-title').textContent = `Registrar Ocorrência para DT: ${selectedOperacao.dt}`;
            document.getElementById('occurrence-modal').classList.remove('hidden');
        };
        window.closeOccurrenceModal = () => document.getElementById('occurrence-modal').classList.add('hidden');
        
        window.showResolutionModal = () => {
            if (!selectedOperacao) return;
            document.getElementById('resolution-modal-title').textContent = `Resolver Ocorrência: ${selectedOperacao.dt}`;
            document.getElementById('resolution-modal-content').innerHTML = `<p><strong>Problema:</strong> ${selectedOperacao.type}</p><p><strong>Descrição:</strong> ${selectedOperacao.description}</p><p><strong>Resolução Anterior:</strong> ${selectedOperacao.resolucao || 'Nenhuma'}</p>`;
            document.getElementById('resolutionText').value = selectedOperacao.resolucao || '';
            document.getElementById('resolutionStatus').value = selectedOperacao.statusOcorrencia || 'Em andamento';
            document.getElementById('resolution-modal').classList.remove('hidden');
        };
        window.closeResolutionModal = () => document.getElementById('resolution-modal').classList.add('hidden');
        
        async function finalizarOperacao() {
             if (!db || !selectedOperacao) return;
             const finalizada = { ...selectedOperacao, status: 'Finalizado', finishedTime: Date.now() };
             await setDoc(doc(db, `artifacts/${appId}/public/data/historico`, selectedOperacao.id), finalizada);
             await deleteDoc(doc(db, `artifacts/${appId}/public/data/patio`, selectedOperacao.id));
        }
        
        async function cancelarOperacao() {
             if (!db || !selectedOperacao) return;
            const cancelada = { ...selectedOperacao, status: 'Cancelado', finishedTime: Date.now() };
            await setDoc(doc(db, `artifacts/${appId}/public/data/historico`, selectedOperacao.id), cancelada);
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/patio`, selectedOperacao.id));
        }

        async function clearHistory() {
            if (!db) return;
            const batch = writeBatch(db);
            historicoData.forEach(item => {
                const docRef = doc(db, `artifacts/${appId}/public/data/historico`, item.id);
                batch.delete(docRef);
            });
            try {
                await batch.commit();
            } catch (error) {
                console.error("Erro ao limpar o histórico: ", error);
            }
        }
        
        window.openWhatsApp = (phone, name, dt) => {
            const cleanPhone = phone.replace(/\D/g, '');
            const message = encodeURIComponent(`Olá ${name}, por favor, dirija-se à doca para o carregamento da DT ${dt}.`);
            window.open(`https://wa.me/55${cleanPhone}?text=${message}`, '_blank');
        }

        window.makeWhatsAppCall = (phone) => {
            const cleanPhone = phone.replace(/\D/g, '');
            window.open(`whatsapp://call?number=55${cleanPhone}`);
        }

        window.makeCall = (phone) => {
            const cleanPhone = phone.replace(/\D/g, '');
            window.open(`tel:${cleanPhone}`);
        }

        async function handleAddOccurrence(e) {
            e.preventDefault();
            if(!db || !selectedOperacao) return;
            const form = document.getElementById('occurrence-form');
            const formData = new FormData(form);
            await addDoc(collection(db, `artifacts/${appId}/public/data/ocorrencias`), {
                type: formData.get('type'), description: formData.get('description'), dt: selectedOperacao.dt, 
                operacaoId: selectedOperacao.id, timestamp: serverTimestamp(), canal: 'Painel',
                prioridade: getPriorityStatusLogic(selectedOperacao).statusText, statusOcorrencia: 'Em andamento', resolucao: ''
            });
            window.closeOccurrenceModal();
            form.reset();
        }

        async function handleUpdateResolution(e) {
            e.preventDefault();
            if (!db || !selectedOperacao) return;
            const form = document.getElementById('resolution-form');
            const formData = new FormData(form);
            const occurrenceRef = doc(db, `artifacts/${appId}/public/data/ocorrencias`, selectedOperacao.id);
            await updateDoc(occurrenceRef, {
                resolucao: formData.get('resolution'),
                statusOcorrencia: formData.get('status'),
                resolvidoEm: formData.get('status') === 'Concluído' ? serverTimestamp() : null
            });
            window.closeResolutionModal();
        }

        const exportToCsv = () => {
             let dataToExport, headers;
             if (activeTab === 'ocorrencias') {
                dataToExport = ocorrenciasData;
                headers = ['Data', 'DT', 'Canal', 'Prioridade', 'Problema Identificado', 'Descrição', 'Status da Ocorrência', 'Resolução', 'Resolvido Em'];
             } else {
                dataToExport = activeTab === 'patio' ? patioData : historicoData;
                headers = ['DT', 'Status', 'Agenda', 'Tempo no Pátio', 'Motorista', 'Transportadora', 'Finalizado Em'];
             }
             const rows = dataToExport.map(op => {
                  if (activeTab === 'ocorrencias') {
                    return [ `"${op.timestamp ? new Date(op.timestamp.seconds * 1000).toLocaleString('pt-BR') : 'N/A'}"`, `"${op.dt}"`, `"${op.canal}"`, `"${op.prioridade}"`, `"${op.type}"`, `"${op.description}"`, `"${op.statusOcorrencia}"`, `"${op.resolucao || ''}"`, `"${op.resolvidoEm ? new Date(op.resolvidoEm.seconds * 1000).toLocaleString('pt-BR') : ''}"` ].join(',');
                  }
                  const { statusText } = getPriorityStatusLogic(op);
                  const tempoPatio = activeTab === 'patio' && op.registrationTime ? getElapsedTime(op.registrationTime) : 'N/A';
                  const finalizadoEm = op.finishedTime ? new Date(op.finishedTime).toLocaleString('pt-BR') : 'N/A';
                  return [ `"${op.dt || ''}"`, `"${statusText}"`, `"${op.agenda || ''}"`, `"${tempoPatio}"`, `"${op.motorista || ''}"`, `"${op.transportadora || ''}"`, `"${finalizadoEm}"` ].join(',');
             });
             const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `heilog_export_${activeTab}_${new Date().toISOString().split('T')[0]}.csv`);
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        }
    </script>
</body>
</html>
